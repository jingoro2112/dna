/* Copyright: (c) 2013 by Curt Hartung
 * This work is released under the Creating Commons 3.0 license
 * found at http://creativecommons.org/licenses/by-nc-sa/3.0/legalcode
 * and in the LICENCE.txt file included with this distribution
 */

#include <dna.h>
#include <usb.h>
#include <oled.h>
#include <i2c.h>
#include <24c512.h>

#include "sram.h"

#include <util/delay.h>
#include <avr/io.h>
#include <avr/interrupt.h>

volatile unsigned char oledBusy = 0;

unsigned char d[8];
//------------------------------------------------------------------------------
unsigned char dnaUsbInputSetup( unsigned char *data, unsigned char len )
{
	switch( data[0] )
	{
		case 1:
		{
			d[0] = 0xA1;
			d[1] = 0xB2;
			d[2] = 0xC1;
			d[3] = 0xD1;
			while( oledBusy );
			oledBusy = 1;
			sramWrite( 120, d[0] );
			sramWrite( 130, d[1] );
			sramWrite( 140, d[2] );
			sramWrite( 150, d[3] );
			oledBusy = 0;

//			write24c512( 0xA0, 100, d, 4 );
//			write24c512( 0xA0, 101, d+1, 1 );
//			write24c512( 0xA0, 102, d+2, 1 );
//			write24c512( 0xA0, 103, d+3, 1 );
			break;
		}

		case 2:
		{
			d[0] = 1;
			d[1] = 2;
			d[2] = 3;
			d[3] = 4;
			while( oledBusy );
			oledBusy = 1;
			d[0] = sramRead( 120 );
			d[1] = sramRead( 130 );
			d[2] = sramRead( 140 );
			d[3] = sramRead( 150 );
			oledBusy = 0;
//			read24c512( 0xA0, 100, d, 4 );
//			read24c512( 0xA0, 101, d+1, 1 );
//			read24c512( 0xA0, 102, d+2, 1 );
//			read24c512( 0xA0, 103, d+3, 1 );
			dnaUsbQueueData( d, 4 );
			
			break;
		}
	}


	return 0;
}

//------------------------------------------------------------------------------
void dnaUsbInputStream( unsigned char *data, unsigned char len )
{
	
}

#define ledOn()  (PORTB &= 0b11111110)
#define ledOff() (PORTB |= 0b00000001)


uint8_t logo1[4][132] = 
{
	{ 0x00,0x00,0x00,0x00,0x00,0x80,0xC0,0xE0,0xF0,0xF8,0x0C,0x06,0x03,0x01,0x03,0x06,
	0xCC,0xE0,0xF0,0xF8,0xFC,0x06,0x03,0x01,0x03,0x06,0x0C,0xF8,0xF0,0xE0,0xC0,0x80,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xC0,0xC0,0x80,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00 },
	{ 0x00,0x00,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,0x00,0x00,0x00,
	0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0xB6,0xB6,0xB6,0xB6,0xB6,0xB6,0xB6,0xB6,0xB6,0xB6,
	0xB6,0xB6,0xB6,0x00,0x00,0xE0,0xF8,0x38,0x1C,0x1C,0x1C,0x3C,0x78,0xF0,0xC0,0x00,
	0x00,0x7C,0xFC,0xC0,0x00,0x00,0x00,0x00,0x00,0xF1,0xFF,0x1F,0x7C,0xE0,0x00,0x00,
	0x00,0x30,0x38,0x1C,0x8C,0xCC,0xF8,0xF0,0x00,0x00,0x78,0xFC,0x0C,0x0C,0x00,0x78,
	0xFC,0xCC,0x8C,0x98,0xFC,0xFC,0x00,0x00,0x3C,0xFC,0xC0,0x00,0x7C,0xFC,0xC0,0x00,
	0x00,0xF0,0xF8,0x1C,0x0C,0x0C,0x1C,0x38,0xF0,0xC0,0x00,0x7C,0xFC,0xC0,0x00,0x00,
	0x00,0x3C,0xFC,0xC0,0x00,0x78,0xFC,0x0C,0x0C,0x00,0x1C,0x3C,0x7C,0xCC,0x8C,0x0C,
	0x0C,0x00,0x00,0x00 },
	{ 0x00,0x00,0x7F,0x7F,0x7F,0x7F,0x7F,0x7F,0x7F,0x7F,0x7F,0x7F,0x7F,0x00,0x00,0x00,
	0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x6D,0x6D,0x6D,0x6D,0x6D,0x6D,0x6D,0x6D,0x6D,0x6D,
	0x6D,0x6D,0x6D,0x00,0x00,0x1F,0x7F,0xF0,0xC0,0x80,0x80,0x80,0x80,0xC0,0xF0,0x30,
	0x00,0x00,0x3F,0x3F,0x0C,0x18,0x38,0x20,0x00,0x3F,0x3F,0x00,0x00,0x03,0x1F,0x3C,
	0x20,0x00,0x0F,0x1F,0x33,0x31,0x31,0x38,0x18,0x00,0x30,0x3F,0xFC,0xB0,0x30,0x00,
	0x0C,0x1C,0x31,0x31,0x31,0x3F,0x1F,0x00,0x00,0x7F,0xFF,0x80,0x30,0x7F,0xFF,0xB0,
	0x30,0x07,0x0F,0x1C,0x38,0x30,0x30,0x38,0x1F,0x07,0x00,0x00,0x3F,0x3F,0x0C,0x10,
	0x30,0x30,0x3F,0x1F,0x00,0x30,0x3F,0xFC,0xB0,0x30,0x00,0x30,0x30,0x31,0x33,0x3E,
	0x3C,0x38,0x00,0x00 },
	{ 0x00,0x00,0x00,0x00,0x00,0x01,0x03,0x07,0x0F,0x1F,0x30,0x60,0xC0,0x80,0xC0,0x60,
	0x33,0x07,0x0F,0x1F,0x3F,0x60,0xC0,0x80,0xC0,0x60,0x30,0x1F,0x0F,0x07,0x03,0x01,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x03,0x03,0x03,0x03,0x01,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x03,0x00,0x00,0x01,0x03,
	0x03,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00 },
};

uint8_t logo2[4][132] =
{
	{0x00,0xF8,0x00,0x00,0x00,0xF8,0x00,0x00,0xF8,0x08,0xF8,0x08,0xFF,0x10,0x08,0x18,0xF0,0x00,0x00,0x08,0x00,0x38,0xC0,0x00,0x38,0xC0,0x00,0xE0,0x18,0xE0,0x00,0xE0,0x18,0xE0,0x00,0xE0,0x18,0xE0,0x00,0xE0,0x18,0xE0,0x00,0xE0,0x18,0xE0,0x00,0xE0,0x18,0xE0,0x00,0x00,0x08,0x00,0xF0,0x08,0x08,0x30,0x00,0xF8,0x00,0x00,0x00,0x01,0xE1,0x1E,0xE0,0x00,0x00,0x30,0x88,0x88,0x70,0x00,0xF8,0x08,0x30,0x48,0x48,0x90,0xF8,0x00,0xF8,0x00,0xF8,0x00,0xF0,0x18,0x08,0x18,0xF0,0x00,0xF8,0x00,0x00,0x00,0xF8,0x00,0xF8,0x08,0x18,0x68,0x88,0x08,0x00,0x00,0x08,0x00,0xF0,0x08,0x08,0x30,0x00,0xF0,0x18,0x08,0x18,0xF0,0x00,0x00,0xF8,0x00,0x00,0xF8,0x00,0x00,0xF8,0x00},
	{0x00,0x3F,0x02,0x04,0x04,0x03,0x00,0x04,0x3F,0x04,0x3F,0x04,0x07,0x02,0x04,0x06,0x03,0x00,0x00,0x04,0x00,0x00,0x03,0x3C,0x00,0x03,0x3C,0x07,0x00,0x01,0x06,0x01,0x00,0x07,0x00,0x07,0x00,0x01,0x06,0x01,0x00,0x07,0x00,0x07,0x00,0x01,0x06,0x01,0x00,0x07,0x00,0x00,0x00,0x00,0x03,0x04,0x04,0x03,0x00,0x07,0x02,0x04,0x00,0x06,0x01,0x00,0x01,0x06,0x00,0x03,0x04,0x04,0x02,0x04,0x3F,0x04,0x03,0x04,0x04,0x04,0x03,0x00,0x3F,0x04,0x3F,0x24,0x03,0x06,0x04,0x06,0x03,0x00,0x07,0x02,0x04,0x04,0x03,0x04,0x3F,0x04,0x04,0x04,0x05,0x06,0x00,0x00,0x00,0x00,0x03,0x04,0x04,0x03,0x00,0x03,0x06,0x04,0x06,0x03,0x00,0x00,0x07,0x04,0x04,0x07,0x04,0x04,0x03,0x00},
	{0x00,0xF0,0x0C,0x02,0x02,0x02,0x0C,0x30,0x00,0x00,0x00,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x0E,0xF0,0x40,0x40,0x40,0xF0,0x0E,0x00,0x00,0xFE,0x02,0x02,0x02,0x02,0x00,0x00,0x00,0x00,0x00,0xFE,0x00,0x00,0x00,0x00,0x06,0x1A,0x22,0xC2,0x82,0x02,0x00,0x00,0xF8,0x86,0x02,0x02,0x86,0xF8,0x00,0x00,0x18,0x04,0x02,0x02,0x84,0xF8,0x00,0x00,0x06,0x1A,0x22,0xC2,0x82,0x02,0x00,0x00,0x00,0xFE,0x02,0x02,0x02,0x02,0x0C,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x06,0x02,0x82,0x46,0x3C,0x00,0x00,0x00,0xF8,0x46,0x42,0x46,0xCC,0x00,0x00,0x00,0xFE,0x00,0x00,0x00,0x00,0xFE,0x00,0x00,0x00,0xF8,0x46,0x42,0x46,0xCC,0x00,0x00,0x8C,0x42,0x42,0x22,0x3C,0x00},
	{0x00,0x0F,0x30,0x40,0x40,0x40,0x20,0x18,0x00,0x00,0x00,0x7F,0x41,0x41,0x41,0x41,0x40,0x00,0x00,0x01,0x3F,0x40,0x3E,0x01,0x00,0x00,0x00,0x7F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x30,0xFF,0x00,0x00,0x00,0x00,0x30,0xC0,0x80,0x80,0xC3,0x3E,0x00,0x00,0x3E,0xC3,0x81,0x81,0x43,0x3E,0x00,0x00,0x60,0x80,0x81,0x81,0xC3,0x3C,0x00,0x00,0x30,0xC0,0x80,0x80,0xC3,0x3E,0x00,0x00,0x00,0x7F,0x40,0x40,0x40,0x40,0x30,0x0F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3E,0x61,0x41,0x40,0x60,0x18,0x00,0x00,0x00,0x01,0x06,0x04,0x06,0x01,0x00,0x00,0x00,0x07,0x03,0x06,0x00,0x00,0x47,0x00,0x00,0x00,0x01,0x06,0x04,0x06,0x01,0x00,0x00,0x03,0x04,0x04,0x04,0x03,0x00},
};

//------------------------------------------------------------------------------
void show_bitmap(unsigned char bitmap)
{
	unsigned int i;

	unsigned char counter = 1;

	i2cStartWrite( OLED_ADDRESS );

	i2cWrite( 0x80 ); // command setup
	i2cWrite( 0x00 );
	i2cWrite( 0x80 ); // command setup
	i2cWrite( 0x10 );
	i2cWrite( 0x80 ); // command setup
	i2cWrite( 0xB0 );

	for( i=0; i<512; i++ )
	{
		counter = counter + 2;
		i2cWrite( 0xC0 ); // data setup
		i2cWrite( bitmap );
	}

	i2cStop();
}

//------------------------------------------------------------------------------
void sram2oled( unsigned int address )
{
	i2cStartWrite( OLED_ADDRESS );
	i2cWrite( 0x80 ); // command setup
	i2cWrite( 0x00 );
	i2cWrite( 0x80 ); // command setup
	i2cWrite( 0x10 );
	i2cWrite( 0x80 ); // command setup
	i2cWrite( 0xB0 );

	while( oledBusy );
	oledBusy = 1;

	sramStartRead( address );

	unsigned int i;
	unsigned char ret;
	for( i=0; i<512; i++ )
	{
		ret = 0;
		sramSetSCKHigh();
		if ( sramGetSO() )
		{
			ret |= 0b10000000;
		}
		sramSetSCKLow();
		sramSetSCKHigh();
		if ( sramGetSO() )
		{
			ret |= 0b01000000;
		}
		sramSetSCKLow();
		sramSetSCKHigh();
		if ( sramGetSO() )
		{
			ret |= 0b00100000;
		}
		sramSetSCKLow();
		sramSetSCKHigh();
		if ( sramGetSO() )
		{
			ret |= 0b00010000;
		}
		sramSetSCKLow();
		sramSetSCKHigh();
		if ( sramGetSO() )
		{
			ret |= 0b00001000;
		}
		sramSetSCKLow();
		sramSetSCKHigh();
		if ( sramGetSO() )
		{
			ret |= 0b00000100;
		}
		sramSetSCKLow();
		sramSetSCKHigh();
		if ( sramGetSO() )
		{
			ret |= 0b00000010;
		}
		sramSetSCKLow();
		sramSetSCKHigh();
		if ( sramGetSO() )
		{
			ret |= 0b00000001;
		}
		sramSetSCKLow();
		i2cWriteNoWait( 0xC0 ); // data setup
		i2cWriteNoWait( ret );
	}

	sramStop();

	i2cWait();
	i2cStop();
	
	oledBusy = 0;
}

//------------------------------------------------------------------------------
int __attribute__((noreturn)) main(void)
{
	DDRB = 0b00000111;
	DDRC = 0b00110001;
	DDRD = 0b10100000;
	PORTD = 0b01000000;

	sramInit();
	
	ledOff();

	i2cInit( 10 );

	usbInit();
	
	usbDeviceDisconnect();
	_delay_ms( 250 );
	usbDeviceConnect();

	oledInit();
	oledPowerOff();

	TCCR0B = 1<<CS01; // set 8-bit timer prescaler to /8 for 5859.375 intterupts per second @12mHz
	TIMSK0 = 1<<TOIE0; // fire off an interrupt every time it overflows, this is our tick (~170 microseconds per)

	sei();

	unsigned char counter;
	for(;;)
	{
/*
		ledOn();
		sram2oled( counter );
		counter += 10;
		ledOff();
		_delay_ms(10);
*/
/*
		sram2oled( 0x0 );
		ledOn();
//		_delay_ms(1000);
		oledClear();
		ledOff();
//		_delay_ms(1000);
		
//		show_bitmap( counter++ );
//		*/
	}
}

//------------------------------------------------------------------------------
ISR( TIMER0_OVF_vect )
{
	usbPoll();
}
